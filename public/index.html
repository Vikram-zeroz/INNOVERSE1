<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CivicConnect — Crowdsourced Civic Issue Reporting (SIH25031)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#0069ff;--muted:#6c757d}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;line-height:1.6}
    .hero{background:linear-gradient(135deg, rgba(0,105,255,0.12), rgba(4,196,255,0.06));padding:6rem 0}
    .card-decor{border-left:4px solid var(--accent)}
    .feature-icon{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;background:rgba(0,105,255,0.08);font-size:22px}
    .badge-soft{background:rgba(0,105,255,0.08);color:var(--accent);padding:.35rem .6rem;border-radius:999px;font-weight:600}
    footer{background:#081226;color:#cfe7ff;padding:2rem 0}
    .glow{box-shadow:0 6px 30px rgba(0,105,255,0.08)}
    @media (max-width:575px){.hero{padding:3rem 0}}
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow-sm">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="#">
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#0069ff"/><path d="M7 12h10M7 8h6M7 16h10" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>
        <div style="font-weight:700">CivicConnect</div>
        <small class="text-muted" style="font-size:11px">SIH25031 — Crowdsourced Civic Issue Reporting</small>
      </div>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navmenu">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="admin.html">Admin Dashboard</a></li>
      </ul>
    </div>
  </div>
</nav>

<header class="hero">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-7">
        <h1 class="display-5 fw-bold">CivicConnect — report civic issues in one tap</h1>
        <p class="lead text-muted">A crowdsourced platform to report, track and resolve civic problems — from potholes to broken streetlights — with transparent ticketing and analytics for local authorities.</p>

        <div class="mt-4 d-flex gap-3">
          <div class="p-3 bg-white rounded shadow-sm card-decor">
            <div class="small text-muted">Tickets Created</div>
            <div id="ticketsCreated" class="h4 mb-0">0</div>
          </div>
          <div class="p-3 bg-white rounded shadow-sm card-decor">
            <div class="small text-muted">Active Areas</div>
            <div class="h4 mb-0">--</div>
          </div>
        </div>
      </div>

      <div class="col-lg-5 mt-4 mt-lg-0">
        <div class="card glow">
          <div class="card-body">
            <form id="reportForm">
              <h5 class="card-title">Quick Report</h5>

              <div class="mb-2">
                <label class="form-label small">Issue Category</label>
                <select id="category" class="form-select" required>
                  <option value="Road / Pothole">Road / Pothole</option>
                  <option value="Garbage">Garbage</option>
                  <option value="Streetlight">Streetlight</option>
                  <option value="Water Leakage">Water Leakage</option>
                  <option value="Public Safety">Public Safety</option>
                  <option value="Stray Animals">Stray Animals</option>
                  <option value="others">other</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label small">Short Description</label>
                <input id="description" class="form-control" placeholder="e.g. Deep pothole near bus stop" required>
              </div>

              <div class="mb-2">
                <label class="form-label small">Upload Photo</label>
                <!-- live camera capture added -->
                <input 
                  class="form-control" 
                  type="file" 
                  id="issueImage" 
                  accept="image/*" 
                  capture="environment" 
                  required>
                <div class="small text-muted mt-1">
                  Take a live photo (camera) or choose from gallery. We will read photo's geotag (EXIF) if available.
                </div>
              </div>

              <div class="mb-2 d-flex gap-2">
                <input class="form-control" placeholder="Location (auto-detect)" id="locationInput" readonly>
                <button class="btn btn-outline-secondary" type="button" id="detectBtn">Detect</button>
              </div>

              <div class="mb-2">
                <div id="locationSource" class="small text-muted">Location source: —</div>
              </div>

              <div class="d-flex gap-2">
                <button class="btn btn-success flex-grow-1" type="submit">Submit Report</button>
                <button class="btn btn-outline-danger" type="reset">Reset</button>
              </div>
              
              <div class="mt-2">
                <div id="photoCounter" class="small text-muted">Total photos shared: 0</div>
              </div>

            </form>
          </div>
        </div>
      </div>

    </div>
  </div>
</header>

<footer>
  <div class="container d-flex justify-content-between align-items-center">
    <div>
      <strong>CivicConnect</strong>
      <div class="small">SIH25031 — Crowdsourced Civic Issue Reporting and Resolution System</div>
    </div>
    <div class="small text-muted">Built for Smart India Hackathon • Demo Project</div>
  </div>
</footer>

<!-- EXIF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// === same JavaScript as before (handles EXIF, GPS, uploading, counters) ===
const imageInput = document.getElementById('issueImage');
const locationInput = document.getElementById('locationInput');
const locationSourceEl = document.getElementById('locationSource');
const detectBtn = document.getElementById('detectBtn');
const photoCounter = document.getElementById('photoCounter');
const ticketsCreated = document.getElementById('ticketsCreated');

let lastDetected = { lat: null, lon: null, source: null };

function exifDMSToDeg(dms, ref) {
  if (!dms) return null;
  const deg = dms[0] + dms[1] / 60 + dms[2] / 3600;
  return (ref === 'S' || ref === 'W') ? -deg : deg;
}

function getExifGPS(file) {
  return new Promise((resolve) => {
    try {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = function () {
        EXIF.getData(img, function () {
          const lat = EXIF.getTag(this, 'GPSLatitude');
          const lon = EXIF.getTag(this, 'GPSLongitude');
          const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
          const lonRef = EXIF.getTag(this, 'GPSLongitudeRef');
          if (lat && lon) {
            resolve({ lat: exifDMSToDeg(lat, latRef), lon: exifDMSToDeg(lon, lonRef) });
          } else resolve(null);
        });
      };
      img.onerror = () => resolve(null);
      img.src = url;
    } catch { resolve(null); }
  });
}

function detectBrowserLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) return reject(new Error("Geolocation not supported."));
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
      err => reject(err),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
}

function setLocationUI(lat, lon, source) {
  lastDetected = { lat, lon, source };
  locationInput.value = lat && lon ? `${lat.toFixed(6)}, ${lon.toFixed(6)}` : '';
  locationSourceEl.innerText = "Location source: " + (source || '—');
}

detectBtn.addEventListener('click', async () => {
  try {
    setLocationUI(null, null, 'detecting...');
    const pos = await detectBrowserLocation();
    setLocationUI(pos.lat, pos.lon, 'Browser Geolocation');
  } catch (err) {
    alert("Unable to detect location: " + err.message);
    setLocationUI(null, null, 'failed');
  }
});

imageInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  setLocationUI(null, null, 'reading photo EXIF...');
  const exif = await getExifGPS(file);
  if (exif) setLocationUI(exif.lat, exif.lon, 'Photo EXIF');
  else setLocationUI(null, null, 'No EXIF found — will ask browser');
});

document.getElementById('reportForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const file = imageInput.files[0];
  if (!file) return alert("Please upload a photo.");

  const description = document.getElementById('description').value.trim();
  const category = document.getElementById('category').value;

  let lat = lastDetected.lat, lon = lastDetected.lon;
  if (!lat || !lon) {
    try {
      const pos = await detectBrowserLocation();
      lat = pos.lat; lon = pos.lon;
      setLocationUI(lat, lon, 'Browser Geolocation');
    } catch {
      setLocationUI(null, null, 'No location');
    }
  }

  const fd = new FormData();
  fd.append("image", file);
  fd.append("description", description);
  fd.append("category", category);
  if (lat && lon) {
    fd.append("lat", lat);
    fd.append("lon", lon);
  }

  try {
    const res = await fetch("/api/report", { method: "POST", body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Upload failed");
    alert("Report submitted! Ticket ID: " + data.ticketId);
    e.target.reset();
    setLocationUI(null, null, '—');
    updateCounts();
  } catch (err) {
    alert("Error: " + err.message);
  }
});

async function updateCounts() {
  try {
    const res = await fetch("/api/count");
    const json = await res.json();
    photoCounter.innerText = "Total photos shared: " + (json.count ?? 0);
    ticketsCreated.innerText = (json.count ?? 0);
  } catch {}
}
updateCounts();
setInterval(updateCounts, 10000);
</script>
</body>
</html>

